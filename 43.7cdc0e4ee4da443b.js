"use strict";(self.webpackChunkblog_app=self.webpackChunkblog_app||[]).push([[43],{7043:(b,y,l)=>{l.d(y,{j:()=>A});var u=l(3014),f=l(3107),t=l(4522),p=l(3756),_=l(7082),C=l(1217),v=l(8447);let A=(()=>{class h{firestore=(0,f.WQX)(t._7);authService=(0,f.WQX)(_.u);BATCH_SIZE=10;MAX_DEPTH=10;commentsSubject=new C.t([]);comments$=this.commentsSubject.asObservable();pendingCommentsSubject=new v.B;pendingCommentsChanged$=this.pendingCommentsSubject.asObservable();loadedPostId=null;addComment(s){var e=this;return(0,u.A)(function*(){const o=e.authService.currentUser();if(!o)throw new Error("You must be logged in to add a comment");const n=e.authService.profile();if(!n)throw new Error("User profile not found");try{let r=0;if(s.parentId){const m=yield e.getCommentById(s.parentId);m&&(r=Math.min(m.depth+1,e.MAX_DEPTH),yield e.incrementReplyCount(s.parentId))}const i="admin"===n.role||"author"===n.role,c=(0,t.rJ)(e.firestore,"comments"),d={postId:s.postId,content:s.content,authorId:o.uid,authorName:n.displayName||o.displayName||"Anonymous",depth:r,status:i?"approved":"pending",createdAt:(0,p.O5)(),updatedAt:(0,p.O5)(),likes:0,replyCount:0};s.parentId&&(d.parentId=s.parentId),(n.photoURL||o.photoURL)&&(d.authorPhotoURL=n.photoURL||o.photoURL);const a=yield(0,t.gS)(c,d);return i||e.pendingCommentsSubject.next(),a.id}catch(r){throw console.error("Error adding comment:",r),r}})()}getCommentById(s){var e=this;return(0,u.A)(function*(){try{const o=(0,t.H9)(e.firestore,"comments",s),n=yield(0,t.x7)(o);return n.exists()?{id:n.id,...n.data()}:null}catch(o){return console.error("Error getting comment:",o),null}})()}getTopLevelComments(s,e){var o=this;return(0,u.A)(function*(){try{const n=(0,t.rJ)(o.firestore,"comments");let r=[(0,t._M)("postId","==",s),(0,t._M)("parentId","==",null),(0,t._M)("status","==","approved"),(0,t.My)("createdAt","desc")];e&&r.push((0,t.HM)(e)),r.push((0,t.AB)(o.BATCH_SIZE));const i=(0,t.P)(n,...r),c=yield(0,t.GG)(i);return{comments:c.docs.map(m=>({id:m.id,...m.data()})),lastVisible:c.docs.length>0?c.docs[c.docs.length-1]:null}}catch(n){return console.error("Error getting comments:",n),{comments:[],lastVisible:null}}})()}loadCommentsForPost(s){var e=this;return(0,u.A)(function*(){try{e.loadedPostId=s;const o=(0,t.rJ)(e.firestore,"comments"),n=(0,t.P)(o,(0,t._M)("postId","==",s),(0,t._M)("status","==","approved"),(0,t.My)("createdAt","desc")),i=(yield(0,t.GG)(n)).docs.map(c=>({id:c.id,...c.data()}));return e.commentsSubject.next(i),i}catch(o){return console.error("Error loading comments for post:",o),[]}})()}getRepliesByCommentId(s,e){var o=this;return(0,u.A)(function*(){try{const n=(0,t.rJ)(o.firestore,"comments");let r=[(0,t._M)("parentId","==",s),(0,t._M)("status","==","approved"),(0,t.My)("createdAt","asc")];e&&r.push((0,t.HM)(e)),r.push((0,t.AB)(o.BATCH_SIZE));const i=(0,t.P)(n,...r),c=yield(0,t.GG)(i);return{replies:c.docs.map(m=>({id:m.id,...m.data()})),lastVisible:c.docs.length>0?c.docs[c.docs.length-1]:null}}catch(n){return console.error("Error getting replies:",n),{replies:[],lastVisible:null}}})()}updateComment(s,e){var o=this;return(0,u.A)(function*(){const n=o.authService.currentUser();if(!n)throw new Error("You must be logged in to update a comment");try{const r=(0,t.H9)(o.firestore,"comments",s),i=yield(0,t.x7)(r);if(!i.exists())throw new Error("Comment not found");const c=i.data(),d=o.authService.profile();if(c.authorId!==n.uid&&"admin"!==d?.role)throw new Error("You do not have permission to update this comment");const a={...e,updatedAt:(0,p.O5)()};if(e.content&&"admin"!==d?.role&&(a.status="pending",o.pendingCommentsSubject.next()),yield(0,t.mZ)(r,a),o.loadedPostId===c.postId){const m=o.commentsSubject.value,E={...c,...e,updatedAt:new Date,id:s,status:a.status||c.status},S=m.map(g=>g.id===s?E:g);o.commentsSubject.next(S)}}catch(r){throw console.error("Error updating comment:",r),r}})()}deleteComment(s){var e=this;return(0,u.A)(function*(){const o=e.authService.currentUser();if(!o)throw new Error("You must be logged in to delete a comment");try{const n=(0,t.H9)(e.firestore,"comments",s),r=yield(0,t.x7)(n);if(!r.exists())throw new Error("Comment not found");const i=r.data(),c=e.authService.profile();if(i.authorId!==o.uid&&"admin"!==c?.role)throw new Error("You do not have permission to delete this comment");if(i.replyCount&&i.replyCount>0?yield(0,t.mZ)(n,{content:"[This comment has been deleted]",status:"deleted",updatedAt:(0,p.O5)()}):(yield(0,t.kd)(n),i.parentId&&(yield e.decrementReplyCount(i.parentId))),e.loadedPostId===i.postId){const d=e.commentsSubject.value;if(i.replyCount&&i.replyCount>0){const a=d.map(m=>m.id===s?{...m,content:"[This comment has been deleted]",status:"deleted",updatedAt:new Date}:m);e.commentsSubject.next(a)}else{const a=d.filter(m=>m.id!==s);e.commentsSubject.next(a)}}}catch(n){throw console.error("Error deleting comment:",n),n}})()}moderateComment(s,e){var o=this;return(0,u.A)(function*(){if("admin"!==o.authService.profile()?.role)throw new Error("Only admins can moderate comments");try{const r=(0,t.H9)(o.firestore,"comments",s);yield(0,t.mZ)(r,{status:e,updatedAt:(0,p.O5)()});const i=yield(0,t.x7)(r);if(i.exists()){const c=i.data();if(o.loadedPostId===c.postId){const a=o.commentsSubject.value.map(m=>m.id===s?{...m,status:e,updatedAt:new Date}:m);o.commentsSubject.next(a)}}o.pendingCommentsSubject.next()}catch(r){throw console.error("Error moderating comment:",r),r}})()}likeComment(s){var e=this;return(0,u.A)(function*(){if(!e.authService.currentUser())throw new Error("You must be logged in to like a comment");try{const n=(0,t.H9)(e.firestore,"comments",s);yield(0,t.mZ)(n,{likes:(0,t.GV)(1)});const r=yield(0,t.x7)(n);if(r.exists()){const i=r.data();if(e.loadedPostId===i.postId){const d=e.commentsSubject.value.map(a=>a.id===s?{...a,likes:(a.likes||0)+1}:a);e.commentsSubject.next(d)}}}catch(n){throw console.error("Error liking comment:",n),n}})()}getPendingComments(s){var e=this;return(0,u.A)(function*(){if("admin"!==e.authService.profile()?.role)throw new Error("Only admins can view pending comments");try{const n=(0,t.rJ)(e.firestore,"comments");let r=[(0,t._M)("status","==","pending"),(0,t.My)("createdAt","asc")];s&&r.push((0,t.HM)(s)),r.push((0,t.AB)(e.BATCH_SIZE));const i=(0,t.P)(n,...r),c=yield(0,t.GG)(i);return{comments:c.docs.map(m=>({id:m.id,...m.data()})),lastVisible:c.docs.length>0?c.docs[c.docs.length-1]:null}}catch(n){return console.error("Error getting pending comments:",n),{comments:[],lastVisible:null}}})()}getPendingCommentsWithCount(){var s=this;return(0,u.A)(function*(){try{const{comments:e,lastVisible:o}=yield s.getPendingComments(),n=(0,t.rJ)(s.firestore,"comments"),r=(0,t.P)(n,(0,t._M)("status","==","pending"));return{comments:e,lastVisible:o,count:(yield(0,t.d_)(r)).data().count}}catch(e){return console.error("Error getting pending comments with count:",e),{comments:[],lastVisible:null,count:0}}})()}getFlaggedComments(s){var e=this;return(0,u.A)(function*(){if("admin"!==e.authService.profile()?.role)throw new Error("Only admins can view flagged comments");try{const n=(0,t.rJ)(e.firestore,"comments");let r=[(0,t._M)("status","==","flagged"),(0,t.My)("updatedAt","desc")];s&&r.push((0,t.HM)(s)),r.push((0,t.AB)(e.BATCH_SIZE));const i=(0,t.P)(n,...r),c=yield(0,t.GG)(i);return{comments:c.docs.map(m=>({id:m.id,...m.data()})),lastVisible:c.docs.length>0?c.docs[c.docs.length-1]:null}}catch(n){return console.error("Error getting flagged comments:",n),{comments:[],lastVisible:null}}})()}getFlaggedCommentsWithCount(){var s=this;return(0,u.A)(function*(){try{const{comments:e,lastVisible:o}=yield s.getFlaggedComments(),n=(0,t.rJ)(s.firestore,"comments"),r=(0,t.P)(n,(0,t._M)("status","==","flagged"));return{comments:e,lastVisible:o,count:(yield(0,t.d_)(r)).data().count}}catch(e){return console.error("Error getting flagged comments with count:",e),{comments:[],lastVisible:null,count:0}}})()}getRecentlyApprovedComments(s){var e=this;return(0,u.A)(function*(){if("admin"!==e.authService.profile()?.role)throw new Error("Only admins can view this list");try{const n=(0,t.rJ)(e.firestore,"comments");let r=[(0,t._M)("status","==","approved"),(0,t.My)("updatedAt","desc")];s&&r.push((0,t.HM)(s)),r.push((0,t.AB)(e.BATCH_SIZE));const i=(0,t.P)(n,...r),c=yield(0,t.GG)(i);return{comments:c.docs.map(m=>({id:m.id,...m.data()})),lastVisible:c.docs.length>0?c.docs[c.docs.length-1]:null}}catch(n){return console.error("Error getting recently approved comments:",n),{comments:[],lastVisible:null}}})()}getRecentlyApprovedCommentsWithCount(){var s=this;return(0,u.A)(function*(){try{const{comments:e,lastVisible:o}=yield s.getRecentlyApprovedComments(),n=(0,t.rJ)(s.firestore,"comments"),r=new Date;r.setDate(r.getDate()-7);const i=(0,t.P)(n,(0,t._M)("status","==","approved"),(0,t._M)("updatedAt",">=",r));return{comments:e,lastVisible:o,count:(yield(0,t.d_)(i)).data().count}}catch(e){return console.error("Error getting recently approved comments with count:",e),{comments:[],lastVisible:null,count:0}}})()}flagCommentByUser(s,e){var o=this;return(0,u.A)(function*(){const n=o.authService.currentUser();if(!n)throw new Error("You must be logged in to flag a comment");try{const r=(0,t.H9)(o.firestore,"comments",s),i=yield(0,t.x7)(r);if(!i.exists())throw new Error("Comment not found");yield(0,t.mZ)(r,{status:"flagged",flagReason:e,flaggedBy:n.uid,updatedAt:(0,p.O5)()}),o.pendingCommentsSubject.next();const c=i.data();if(o.loadedPostId===c.postId){const a=o.commentsSubject.value.map(m=>m.id===s?{...m,status:"flagged",flagReason:e,updatedAt:new Date}:m);o.commentsSubject.next(a)}}catch(r){throw console.error("Error flagging comment:",r),r}})()}incrementReplyCount(s){var e=this;return(0,u.A)(function*(){try{const o=(0,t.H9)(e.firestore,"comments",s);yield(0,t.mZ)(o,{replyCount:(0,t.GV)(1)})}catch(o){console.error("Error incrementing reply count:",o)}})()}decrementReplyCount(s){var e=this;return(0,u.A)(function*(){try{const o=(0,t.H9)(e.firestore,"comments",s),n=yield(0,t.x7)(o);if(n.exists()){const i=n.data().replyCount||0;yield(0,t.mZ)(o,{replyCount:Math.max(0,i-1)})}}catch(o){console.error("Error decrementing reply count:",o)}})()}clearCache(){this.loadedPostId=null,this.commentsSubject.next([])}static \u0275fac=function(e){return new(e||h)};static \u0275prov=f.jDH({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})()}}]);